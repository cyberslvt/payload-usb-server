<!DOCTYPE html>
<html>
<head>
  <%- include ("../partials/header.ejs") %>
</head>

<body>

  <%- include ("../partials/nav.ejs") %>


  <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  <script>
    var socket = io();

    var targetId = "";

    var query = JSON.parse('<%- JSON.stringify(req.query) %>');
    if(query.name != null) {
      if(localStorage.getItem("device-list") != null){
        const devices = JSON.parse(localStorage.getItem("device-list"));
        let i = 0;
        let found = -1;
        devices.forEach(listing => {
          if (listing.name == query.name) {
            found = i;
          }
          i++;
        });
        if (found > -1){
          targetId = devices[found].id;
          socket.emit("registerListen", targetId);
          console.log("Registered listen");
        } else {
          console.log("Did not find device with name: '" + query.name + "'");
        }
      }
    } else {
      console.log("Name not in query.");
    }

    if(targetId != ""){
      socket.on('deviceConnected', function() {console.log("Device connected");});
      socket.on('deviceLost', function() {console.log("Device lost");});
    }
  </script>

</body>
</html>
